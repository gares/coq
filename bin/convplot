#!/usr/bin/lua5.1

file =  "PFsection13"
test = nil
type1 = "regular"
type2 = "today"

function mk_input(t,v,what,test)
  test = test or what
  local i = io.popen("find . -name '" .. v .. ".v.stats." .. test .. "'")
  for f in i:lines() do
	local j = io.open(f)
	print("reading",f)
	for l in j:lines() do
		local x=loadstring(t.."[#"..t.."+1] = "..
			l:gsub("%)","}"):gsub("%(","{")) 
		if x then x() end
	end
	j:close()
  end
end

data1 = {}
mk_input("data1", file, type1)
data2 = {}
mk_input("data2", file, type2)

od = io.open("/tmp/data","w")
sum1, sum2 = 0.0, 0.0
for i=1, #data1 do
  local d1 = data1[i]
  local d2 = data2[i]
  local v1,l1,f1,b1 = d1[1], d1[2], math.abs(d1[6]), d1[7]
  local v2,l2,f2,b2 = d2[1], d2[2], math.abs(d2[6]), d2[7]
  local delta = math.abs(f1 - f2)
  if delta > 0.01 and delta > f1 * 0.05 then
    assert(v1 == v2 and l1 == l2,v1 .. l1) -- and b1 == b2)
    sum1 = sum1 + f1
    sum2 = sum2 + f2
    od:write(string.format("%d %f %f\n",v1,f1,f2))
  end
 end
od:close()

-- let dataset = float_of_int (List.length data)
-- let avg1 = !sum1 /. dataset
-- let avg2 = !sum2 /. dataset
-- let sigma1, sigma2 = List.fold_left 
--   (fun (s1,s2) ((_,_,_,_,_,f1,_),(_,_,_,_,_,f2,_)) ->
--      (s1 +. ((f1 -. avg1) ** 2.0), s2 +. ((f2 -. avg2) ** 2.0)))
--   (0.0,0.0) data;;
-- Printf.eprintf "old=%f, new=%f, diff=%f, sigma1=%f, sigma2=%f\n"
--   !sum1 !sum2 (!sum1 -. !sum2)
--   (sqrt (sigma1 /. dataset)) (sqrt (sigma2 /.  dataset));;

oc = io.open("/tmp/plot","w")
oc:write(string.format([[
 set terminal png size 1000, 700
 set output "/tmp/plot.png"
 set logscale y
 # set yrange [*:6]
 set ytics 0,.01,6
 set ytics add 3
 set style data points
 plot \
       "/tmp/data" using 1:2 title "]] .. type1 .. [[", \
       "/tmp/data" using 1:3 title "]] .. type2 .. [["  \
]]))
oc:close()

os.execute("gnuplot /tmp/plot")
print("generated /tmp/plot.png")
