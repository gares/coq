#!/usr/bin/lua5.1

file = select(1,...)
file = file or "uu0"
test = nil
type1 = "regular"
type2 = "today"

--setup = 0.0075 -- on battery
setup = 0

function mk_input(t,v,what,test)
  test = test or what
  local i = io.popen("find . -name '" .. v .. ".v.stats." .. test .. "'")
  for f in i:lines() do
	local j = io.open(f)
	print("reading",f)
	for l in j:lines() do
		local x=loadstring(t.."[#"..t.."+1] = "..
			l:gsub("%)","}"):gsub("%(","{")) 
		if x then x() end
	end
	j:close()
  end
end

data1 = {}
mk_input("data1", file, type1)
data2 = {}
mk_input("data2", file, type2)

od = io.open("/tmp/data","w")
for i=1, #data1 do
  local d1 = data1[i]
  local d2 = data2[i]
  if d1 == nil or d2 == nil then break end
  local v1,l1,f1,b1 = d1[1], d1[2], math.abs(d1[6]), d1[7]
  local v2,l2,f2,s1,s2,r2,b2 =
    d2[1], d2[2], math.abs(d2[6]), d2[7], d2[8], d2[9], d2[10]
  local f2o = f2
  f2 = math.max(0,f2 - s1 - s2)
  local delta = math.abs(f1 - (f2 - setup))
  if true or (delta > 0.01 and delta > f1 * 0.05) then
    assert(v1 == v2 and l1 == l2, v1 .. l1) -- and b1 == b2)
    od:write(string.format("%d %f %f %f %f\n",v1,f1,f2,f2o,r2))
  end
 end
od:close()

-- let dataset = float_of_int (List.length data)
-- let avg1 = !sum1 /. dataset
-- let avg2 = !sum2 /. dataset
-- let sigma1, sigma2 = List.fold_left 
--   (fun (s1,s2) ((_,_,_,_,_,f1,_),(_,_,_,_,_,f2,_)) ->
--      (s1 +. ((f1 -. avg1) ** 2.0), s2 +. ((f2 -. avg2) ** 2.0)))
--   (0.0,0.0) data;;
-- Printf.eprintf "old=%f, new=%f, diff=%f, sigma1=%f, sigma2=%f\n"
--   !sum1 !sum2 (!sum1 -. !sum2)
--   (sqrt (sigma1 /. dataset)) (sqrt (sigma2 /.  dataset));;

oc = io.open("/tmp/plot","w")
oc:write(string.format([[
 set terminal png size 1400, 700
 set output "/tmp/plot.png"
 set logscale y
 set grid
 # set yrange [*:6]
 #set ytics 0,.01,6
 #set ytics add 3
 set style data points
 plot \
       "/tmp/data" using 1:2 title "old", \
       "/tmp/data" using 1:3 title "new(no init)",  \
       "/tmp/data" using 1:4 title "new", \
       "/tmp/data" using 1:5 title "new(conv)" 
]]))
oc:close()

os.execute("gnuplot /tmp/plot")
print("generated /tmp/plot.png")
